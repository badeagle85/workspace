# 이미지 서버 흐름도

## 전체 아키텍처

```
┌─────────────────────────────────────────────────────────────────┐
│                        클라이언트                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │ Delivery-Note│  │ 프로젝트 B  │  │ 프로젝트 C  │              │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘              │
└─────────┼────────────────┼────────────────┼─────────────────────┘
          │                │                │
          └────────────────┼────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                     Cloudflare Edge Network                      │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                   Workers (API 서버)                      │    │
│  │  https://image-server.badeagle85.workers.dev             │    │
│  │                                                          │    │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐   │    │
│  │  │ /upload  │ │ /image/* │ │ /images  │ │ /stats   │   │    │
│  │  └────┬─────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘   │    │
│  └───────┼────────────┼────────────┼────────────┼──────────┘    │
│          │            │            │            │                │
│          ▼            ▼            ▼            ▼                │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                   R2 Storage (10GB)                       │    │
│  │                   badeagle85-image                        │    │
│  └─────────────────────────────────────────────────────────┘    │
│                              │                                   │
│                              ▼                                   │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                   CDN (자동 캐싱)                         │    │
│  │                   글로벌 300+ 엣지                        │    │
│  └─────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
```

---

## 이미지 업로드 흐름

```
클라이언트                    Workers                      R2 Storage
    │                           │                              │
    │  POST /upload             │                              │
    │  + X-API-Key 헤더         │                              │
    │  + 이미지 파일             │                              │
    │ ─────────────────────────>│                              │
    │                           │                              │
    │                           │  API Key 검증                │
    │                           │  ───────────┐                │
    │                           │             │                │
    │                           │  <──────────┘                │
    │                           │                              │
    │                           │  파일 검증                    │
    │                           │  - 타입 (JPEG, PNG...)       │
    │                           │  - 크기 (max 1MB)            │
    │                           │  ───────────┐                │
    │                           │             │                │
    │                           │  <──────────┘                │
    │                           │                              │
    │                           │  PUT 이미지                   │
    │                           │ ─────────────────────────────>│
    │                           │                              │
    │                           │           저장 완료           │
    │                           │ <─────────────────────────────│
    │                           │                              │
    │  응답                      │                              │
    │  {                        │                              │
    │    id, url, uploadTime    │                              │
    │  }                        │                              │
    │ <─────────────────────────│                              │
    │                           │                              │
```

---

## 이미지 조회 흐름

```
클라이언트                    Workers                 CDN Cache              R2
    │                           │                        │                   │
    │  GET /image/abc123.jpg    │                        │                   │
    │ ─────────────────────────>│                        │                   │
    │                           │                        │                   │
    │                           │  캐시 확인              │                   │
    │                           │ ──────────────────────>│                   │
    │                           │                        │                   │
    │                           │                        │  캐시 HIT?        │
    │                           │                        │  ────────┐        │
    │                           │                        │          │        │
    │                           │                        │  <───────┘        │
    │                           │                        │                   │
    │                 [캐시 HIT]  │   이미지 반환          │                   │
    │ <─────────────────────────────────────────────────│                   │
    │                           │                        │                   │
    │                           │                        │                   │
    │               [캐시 MISS]  │                        │                   │
    │                           │                        │  GET 이미지       │
    │                           │                        │ ─────────────────>│
    │                           │                        │                   │
    │                           │                        │     이미지        │
    │                           │                        │ <─────────────────│
    │                           │                        │                   │
    │                           │                        │  캐시 저장        │
    │                           │                        │  (1년)            │
    │                           │                        │  ────────┐        │
    │                           │                        │          │        │
    │                           │                        │  <───────┘        │
    │                           │                        │                   │
    │  이미지 반환               │                        │                   │
    │ <─────────────────────────────────────────────────│                   │
    │                           │                        │                   │
```

---

## 이미지 삭제 흐름

```
클라이언트                    Workers                      R2 Storage
    │                           │                              │
    │  DELETE /image/abc123.jpg │                              │
    │  + X-API-Key 헤더         │                              │
    │ ─────────────────────────>│                              │
    │                           │                              │
    │                           │  API Key 검증                │
    │                           │  ───────────┐                │
    │                           │             │                │
    │                           │  <──────────┘                │
    │                           │                              │
    │                           │  이미지 존재 확인             │
    │                           │ ─────────────────────────────>│
    │                           │                              │
    │                           │           존재함             │
    │                           │ <─────────────────────────────│
    │                           │                              │
    │                           │  DELETE 이미지               │
    │                           │ ─────────────────────────────>│
    │                           │                              │
    │                           │           삭제 완료           │
    │                           │ <─────────────────────────────│
    │                           │                              │
    │  응답                      │                              │
    │  { success: true }        │                              │
    │ <─────────────────────────│                              │
    │                           │                              │
```

---

## API 인증 흐름

```
┌─────────────────────────────────────────────────────────────┐
│                        요청 수신                             │
└─────────────────────────┬───────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                   X-API-Key 헤더 확인                        │
└─────────────────────────┬───────────────────────────────────┘
                          │
              ┌───────────┴───────────┐
              │                       │
              ▼                       ▼
┌─────────────────────┐   ┌─────────────────────┐
│     헤더 없음        │   │     헤더 있음        │
└──────────┬──────────┘   └──────────┬──────────┘
           │                         │
           ▼                         ▼
┌─────────────────────┐   ┌─────────────────────┐
│  공개 엔드포인트?    │   │  API Key 일치?       │
│  /health            │   │                     │
│  /image/*           │   └──────────┬──────────┘
└──────────┬──────────┘              │
           │              ┌──────────┴──────────┐
    ┌──────┴──────┐       │                     │
    │             │       ▼                     ▼
    ▼             ▼   ┌────────┐           ┌────────┐
┌────────┐   ┌────────┐│  일치  │           │불일치  │
│  Yes   │   │   No   ││        │           │        │
│ 허용   │   │ 401    ││ 허용   │           │ 401    │
└────────┘   └────────┘└────────┘           └────────┘
```

---

## 파일 검증 흐름

```
┌─────────────────────────────────────────────────────────────┐
│                      파일 업로드 요청                         │
└─────────────────────────┬───────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                   Content-Type 확인                          │
│           (image/jpeg, image/png, image/webp, image/gif)     │
└─────────────────────────┬───────────────────────────────────┘
                          │
              ┌───────────┴───────────┐
              │                       │
              ▼                       ▼
      ┌───────────────┐       ┌───────────────┐
      │   허용 타입    │       │  비허용 타입   │
      └───────┬───────┘       └───────┬───────┘
              │                       │
              ▼                       ▼
┌─────────────────────┐       ┌───────────────┐
│   파일 크기 확인     │       │  400 에러     │
│   (max 1MB)         │       │  "Invalid     │
└──────────┬──────────┘       │   file type"  │
           │                  └───────────────┘
    ┌──────┴──────┐
    │             │
    ▼             ▼
┌────────┐   ┌────────────┐
│ ≤ 1MB  │   │  > 1MB     │
│ 허용   │   │  400 에러  │
│        │   │  "File too │
│        │   │   large"   │
└────────┘   └────────────┘
```

---

## 에러 처리 흐름

```
┌─────────────────────────────────────────────────────────────┐
│                        에러 발생                             │
└─────────────────────────┬───────────────────────────────────┘
                          │
          ┌───────────────┼───────────────┐
          │               │               │
          ▼               ▼               ▼
   ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
   │  400 Error  │ │  401 Error  │ │  404 Error  │
   │  Bad Request│ │ Unauthorized│ │  Not Found  │
   └──────┬──────┘ └──────┬──────┘ └──────┬──────┘
          │               │               │
          ▼               ▼               ▼
   ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
   │ - 파일 없음 │ │ - API Key   │ │ - 이미지    │
   │ - 잘못된    │ │   누락/불일치│ │   없음      │
   │   파일 타입 │ │             │ │ - 잘못된    │
   │ - 파일 크기 │ │             │ │   경로      │
   │   초과      │ │             │ │             │
   └─────────────┘ └─────────────┘ └─────────────┘
          │               │               │
          └───────────────┼───────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                    JSON 에러 응답                            │
│         { "success": false, "error": "메시지" }              │
└─────────────────────────────────────────────────────────────┘
```

---

## 프로젝트별 이미지 관리 (폴더 구조)

```
┌─────────────────────────────────────────────────────────────┐
│                     R2 Storage                               │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                    badeagle85-image                  │    │
│  │                                                      │    │
│  │  📁 delivery-note/                                   │    │
│  │  ├── 1702700001-abc.jpg                             │    │
│  │  └── 1702700002-def.png                             │    │
│  │                                                      │    │
│  │  📁 project-b/                                       │    │
│  │  └── 1702700003-ghi.jpg                             │    │
│  │                                                      │    │
│  │  📁 my-app/                                          │    │
│  │  └── 1702700004-jkl.webp                            │    │
│  │                                                      │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
└─────────────────────────────────────────────────────────────┘

projectId 규칙:
  - 필수 입력
  - 영문 소문자, 숫자, -, _ 만 허용
  - 1~50자

GET /images?projectId=delivery-note
    → delivery-note/1702700001-abc.jpg
    → delivery-note/1702700002-def.png

GET /images?projectId=project-b
    → project-b/1702700003-ghi.jpg

GET /images
    → 모든 프로젝트의 이미지 반환

이미지 URL 형식:
    /image/{projectId}/{id}.{ext}
    예: /image/delivery-note/1702700001-abc.jpg
```
